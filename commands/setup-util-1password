#!/usr/bin/env bash

# Desktop
# https://support.1password.com/install-linux/
# https://aur.archlinux.org/packages/1password
# Fixed for Arch: use EVAL to call yay without elevation (dorothy's AUR handler incorrectly uses --elevate)

function setup_util_1password() (
	source "$DOROTHY/sources/bash.bash"

	# enable GITHUB_BUILD_EVAL
	source "$(type -P setup-util)"

	# =================================
	# Desktop App

	# setup
	local arch reason='Your password is required to momentarily grant privileges to install 1Password.' options=(
		--name='1Password App'
		--cli='1password'
		"$@"
	)
	arch="$(get-arch)"
	function do_apt_keys {
		setup-util-gpg --quiet
		eval-helper --elevate --reason="$reason" -- \
			mkdir -p -- \
			/etc/debsig/policies/AC2D62742012EA22 \
			/usr/share/debsig/keyrings/AC2D62742012EA22
		fetch 'https://downloads.1password.com/linux/debian/debsig/1password.pol' |
			echo-write --binary --reason="$reason" -- \
				/etc/debsig/policies/AC2D62742012EA22/1password.pol
		fetch 'https://downloads.1password.com/linux/keys/1password.asc' |
			eval-helper --elevate --reason="$reason" -- \
				gpg --dearmor --output \
				/usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
	}
	function do_rpm_keys {
		eval-helper --elevate --reason="$reason" -- \
			rpm --import 'https://downloads.1password.com/linux/keys/1password.asc'
		echo-write --reason="$reason" -- /etc/yum.repos.d/1password.repo <<-EOF
			[1password]
			name=1Password Channel
			baseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch
			enabled=1
			gpgcheck=1
			repo_gpgcheck=1
			gpgkey="https://downloads.1password.com/linux/keys/1password.asc"
		EOF
	}
	function do_gpg_keys {
		setup-util-gpg --quiet
		fetch 'https://downloads.1password.com/linux/keys/1password.asc' | gpg --import
	}
	if is-mac; then
		options+=(
			--app='1Password'
			CASK='1password'
		)
	elif is-linux; then
		# Check Arch/Manjaro FIRST before other distros
		if is-arch; then
			do_gpg_keys
			# Use EVAL to bypass dorothy's AUR handler which incorrectly uses --elevate
			# yay handles sudo internally and must not be run as root
			options+=(
				EVAL_INSTALL='yay -S --noconfirm --needed 1password'
				EVAL_UNINSTALL='yay -R --noconfirm 1password'
			)
		elif is-apt; then
			do_apt_keys
			options+=(
				APT='1password'
				APT_KEY='https://downloads.1password.com/linux/keys/1password.asc'
				APT_REPO='deb [arch={ARCH} signed-by={KEY}] https://downloads.1password.com/linux/debian/amd64 stable main'
			)
		elif __command_exists -- rpm yum dnf; then
			do_rpm_keys
			options+=(
				RPM='1password'
			)
		elif is-snap; then
			options+=(
				SNAP='1password'
			)
		elif is-flatpak; then
			options+=(
				FLATPAK='https://downloads.1password.com/linux/flatpak/1Password.flatpakref'
			)
		fi
	fi
	setup-util "${options[@]}"

	# =================================
	# Browser

	__print_style 'Install the 1Password Browser extension by visiting the following URL:' --newline --url='https://1password.com/downloads/browser-extension'
)

# fire if invoked standalone
if [[ $0 == "${BASH_SOURCE[0]}" ]]; then
	setup_util_1password "$@"
fi
